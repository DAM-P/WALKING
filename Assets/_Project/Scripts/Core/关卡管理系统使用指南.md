# 关卡管理系统使用指南

## 概述

关卡管理系统提供统一的 Layout 加载、Collider 生成、实体清理与切换功能，支持运行时动态切换关卡/阶段。

## 核心组件

### 1. StageConfig（ScriptableObject）
每个关卡的配置文件，包含：
- **Layout**：方块布局
- **Cube Prefab**：渲染预制
- **Collider 设置**：碰撞体类型与合并模式
- **玩家出生点**：关卡开始位置
- **过渡效果**：淡入淡出等

### 2. StageManager（MonoBehaviour）
关卡管理器，负责：
- 加载/卸载关卡
- 清理旧实体与碰撞体
- 生成新布局
- 切换过渡效果

### 3. StageCubeTag（IComponentData）
DOTS 实体标记，用于识别和批量清理关卡实体。

### 4. StageManagerTester（MonoBehaviour）
快捷测试脚本，提供按键快速切换关卡。

---

## 使用步骤

### 步骤1：创建关卡配置

1. Project 窗口右键 > Create > Level > **Stage Config**
2. 命名为 `Stage_01`、`Stage_02` 等
3. 配置每个关卡：
   - **Layout**：选择对应的 `CubeLayout.asset`
   - **Cube Prefab**：选择渲染预制（Entities Graphics 兼容）
   - **Collider Type**：推荐 `BoxCollider`
   - **Merge Mode**：推荐 `GreedyMerge`
   - **Player Spawn Point**：设置玩家出生点（如 Vector3(0, 1, 0)）
   - **Transition Duration**：过渡时间（如 1 秒）

### 步骤2：创建碰撞体生成器预制

1. 场景中创建空物体，命名 `ColliderGeneratorPrefab`
2. 添加组件：`CubeLayoutColliderGenerator`
3. 配置默认值（实际值会被 StageManager 覆盖）
4. 拖到 Project 成为 Prefab
5. 从场景中删除

### 步骤3：配置 StageManager

1. 场景中创建空物体，命名 `StageManager`
2. 添加组件：`StageManager`
3. 配置：
   - **Stages**：添加所有关卡配置（按顺序）
   - **Initial Stage Index**：初始关卡索引（如 0）
   - **Collider Generator Prefab**：拖入步骤2的预制
   - **Player Transform**：拖入玩家角色的 Transform
   - **Camera Transform**：拖入相机 Transform（可选）
   - **Fade Panel**：拖入淡入淡出的 UI CanvasGroup（可选）

### 步骤4：（可选）添加测试脚本

1. 在 `StageManager` 物体上添加组件：`StageManagerTester`
2. 配置：
   - **Stage Manager**：拖入 StageManager 组件
   - **Next Stage Key**：设置按键（如 N）
   - **Previous Stage Key**：设置按键（如 P）
   - **Reload Stage Key**：设置按键（如 R）

### 步骤5：创建淡入淡出 UI（可选）

1. Hierarchy 右键 > UI > Canvas
2. Canvas 下创建 UI > Panel，命名 `FadePanel`
3. 设置 Panel：
   - Color：黑色（或任意颜色）
   - Alpha：0（初始透明）
   - 添加组件：`CanvasGroup`
4. 将 `FadePanel` 的 CanvasGroup 拖入 StageManager 的 `Fade Panel` 字段

---

## 运行时使用

### 代码调用

```csharp
using Project.Core.Authoring;

// 获取管理器
var stageManager = FindObjectOfType<StageManager>();

// 加载指定关卡
stageManager.LoadStage(1);

// 加载下一关
stageManager.LoadNextStage();

// 加载上一关
stageManager.LoadPreviousStage();

// 重新加载当前关
stageManager.ReloadCurrentStage();

// 获取当前关卡信息
int currentIndex = stageManager.CurrentStageIndex;
StageConfig currentStage = stageManager.CurrentStage;
```

### 测试按键（如果使用 StageManagerTester）

- **N**：下一关
- **P**：上一关
- **R**：重新加载
- **L**：快速加载指定关卡

---

## 关卡切换流程

1. **淡出**（可选，如果配置了 FadePanel）
2. **清理旧关卡**：
   - 销毁碰撞体生成器
   - 清理所有带 `StageCubeTag` 的实体
3. **生成新关卡**：
   - 实例化新的碰撞体生成器
   - 配置并生成碰撞体
4. **重置玩家位置**：移动到新关卡的出生点
5. **淡入**（可选）

---

## 性能优化建议

### 1. 分帧生成
- `StageConfig.spawnPerFrame` 设置为 2048-4096
- 大关卡（>5000 方块）分批生成，避免卡顿

### 2. 碰撞体优化
- **优先使用 BoxCollider + GreedyMerge**
- 避免 MeshCollider（可能导致卡住）

### 3. 实体清理
- 所有关卡实体都有 `StageCubeTag`，确保彻底清理
- 切换关卡时自动销毁旧实体

### 4. 过渡时间
- `transitionDuration` 设置为 0.5-1.5 秒
- 过长会影响节奏，过短可能看到生成中的方块

---

## 示例场景结构

```
Hierarchy:
├── StageManager
│   ├── StageManager (组件)
│   └── StageManagerTester (组件，可选)
├── Player
│   └── CharacterController
├── Main Camera
└── Canvas
    └── FadePanel (CanvasGroup)

Project:
└── _Project/Configs/Stages/
    ├── Stage_01.asset (StageConfig)
    ├── Stage_02.asset (StageConfig)
    └── Stage_03.asset (StageConfig)
```

---

## 常见问题

### Q: 切换关卡后旧方块还在？
A: 确认：
1. 生成的实体是否有 `StageCubeTag` 组件
2. `StageManager.ClearCubeEntities()` 是否正常调用

### Q: 切换时卡顿？
A: 
- 降低 `spawnPerFrame`
- 使用淡入淡出遮挡生成过程
- 分多个小关卡而非巨型关卡

### Q: 碰撞体没有清理？
A: 
- `StageManager` 会自动销毁旧的 `ColliderGenerator` GameObject
- 如果手动生成，确保挂在子物体上

### Q: 淡入淡出不工作？
A: 
- 确认 `FadePanel` 有 `CanvasGroup` 组件
- 确认 `Canvas` 的 `Render Mode` 为 `Screen Space - Overlay`

---

## 扩展建议

### 1. 添加关卡进度保存
```csharp
PlayerPrefs.SetInt("CurrentStage", stageManager.CurrentStageIndex);
```

### 2. 关卡解锁系统
在 `StageConfig` 添加 `isUnlocked` 字段

### 3. 过渡动画
实现 `TransitionType.Slide` 等自定义过渡

### 4. 预加载下一关
后台预生成碰撞体，缩短切换时间

---

## 总结

关卡管理系统提供了完整的关卡生命周期管理，核心优势：
- ✅ 统一配置（ScriptableObject）
- ✅ 自动清理（实体 + 碰撞体）
- ✅ 平滑过渡（淡入淡出）
- ✅ 易于扩展（代码调用 + 编辑器工具）

适用于：解谜游戏、关卡制、阶段性内容等场景。



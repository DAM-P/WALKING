# 选中失效问题诊断指南

## 🐛 问题描述

**症状**：选中一次 Cube 后，退出选择（ESC/右键），之后无法再次选中任何 Cube。

---

## 🔍 可能原因分析

### 1. 组件被禁用
- `CubeSelectionManager` 脚本被禁用
- `InteractableProxy` GameObject 被禁用
- 主相机丢失

### 2. Entity 被销毁
- 选中的 Entity 被系统销毁
- 代理链接的 Entity 无效

### 3. 输入被拦截
- 其他脚本吸收了鼠标输入
- UI 阻挡了射线检测

### 4. Layer 设置问题
- Proxy GameObject 的 Layer 不在 `interactableLayer` 中
- Raycast Layer Mask 设置错误

### 5. 脚本执行顺序问题
- `ExtendInputManager` 与 `CubeSelectionManager` 执行顺序冲突

---

## 🛠️ 诊断步骤

### 步骤 1：添加诊断工具

1. **找到场景中的空 GameObject**（或创建一个新的）
2. **添加 `SelectionDebugTool` 组件**：
   ```
   GameObject → Create Empty
   Add Component → Selection Debug Tool
   ```
3. **进入 Play 模式**
4. **查看右上角的诊断面板**

### 步骤 2：启用详细日志

1. **找到场景中的 `CubeSelectionManager` 组件**
2. **勾选 `Show Detailed Log`**
3. **进入 Play 模式，点击 Cube**
4. **查看 Console 输出**

#### 正常输出示例：
```
[Selection] 检测到鼠标左键点击
[Selection] 射线: 起点=(0, 1, 0), 方向=(0.5, -0.2, 0.8)
[Selection] 射线命中: Proxy_Entity(123:1), 距离=5.23
[Selection] 找到代理: Entity=Entity(123:1)
[Selection] ✅ 选中 Cube：Entity=Entity(123:1), Type=Extendable
```

#### 异常输出示例：
```
[Selection] 检测到鼠标左键点击
[Selection] 射线未命中任何物体，取消选择  ❌ 问题：射线没命中
```

或

```
[Selection] 射线命中: TestCube, 距离=3.45
[Selection] ⚠️ 命中物体但无代理组件: TestCube  ❌ 问题：没有代理
```

---

## 🔧 常见问题修复

### 问题 1：射线未命中任何物体

#### 原因
- Proxy GameObject 被禁用
- Proxy Collider 被禁用或删除
- Layer 设置错误

#### 修复方法

**检查 1：查看 Proxy 是否存在**
```
1. 进入 Play 模式
2. Hierarchy 搜索 "Proxy_"
3. 查看是否有 Proxy GameObject
4. 检查是否激活（名称前有勾选框）
```

**检查 2：查看 Collider**
```
1. 选中任意 Proxy_XXX GameObject
2. 检查 Inspector 中是否有 Box Collider 组件
3. 确认 Box Collider 的 "Enabled" 已勾选
4. 确认 "Is Trigger" 未勾选（必须为 false）
```

**检查 3：查看 Layer**
```
1. 选中 Proxy GameObject
2. 查看 Inspector 顶部的 "Layer" 设置
3. 找到 CubeSelectionManager 组件
4. 确认 Proxy 的 Layer 在 "Interactable Layer" 中
```

**快速修复**：
```
1. 选中所有 Proxy GameObject（搜索 "Proxy_"）
2. Inspector 顶部 Layer → Default
3. CubeSelectionManager → Interactable Layer → Everything（临时测试）
```

---

### 问题 2：命中物体但无代理组件

#### 原因
- 射线命中了错误的物体（例如地面、墙壁）
- Cube 的碰撞体优先级高于 Proxy

#### 修复方法

**方法 1：调整 Layer 设置**
```
1. 将所有非交互物体（地面、墙壁）设置为 "Terrain" Layer
2. CubeSelectionManager → Interactable Layer → 取消勾选 "Terrain"
3. 确保只有 Proxy 可以被射线命中
```

**方法 2：禁用 Cube Entity 的碰撞**
```
如果 Cube Entity 自己有 BoxCollider（用于物理碰撞），
可能会优先被射线命中。解决方案：

1. 为 Proxy 单独设置一个 Layer（例如 "Interactable"）
2. 只在这个 Layer 上进行射线检测
```

---

### 问题 3：第一次能选中，第二次不行

#### 原因 A：Proxy 被销毁

**检查**：
```
1. 选中一次 Cube
2. 按 ESC 取消选择
3. Hierarchy 中搜索 "Proxy_"
4. 查看 Proxy 数量是否减少
```

**修复**：
检查是否有系统在销毁 Proxy。查看 `InteractableProxySpawnSystem.cs` 是否有销毁逻辑。

#### 原因 B：Entity 被销毁

**检查**：
```
1. 启用 `CubeSelectionManager.showDetailedLog`
2. 第二次点击时查看日志
3. 如果显示 "代理的 linkedEntity 为空"，说明 Entity 被销毁
```

**修复**：
检查 `ExtendExecutionSystem.cs` 或其他系统是否销毁了原始 Entity。

#### 原因 C：组件被禁用

**检查**：
```
1. 选中场景中的 CubeSelectionManager GameObject
2. 确认 Inspector 中 CubeSelectionManager 脚本的勾选框已勾选
3. 确认 GameObject 本身已激活
```

**修复**：
```csharp
// 如果 ExtendInputManager 禁用了 CubeSelectionManager，检查代码：
if (autoDisableMovement && playerController != null)
{
    playerController.enabled = false; // ✅ 只禁用 playerController
    // selectionManager.enabled = false; // ❌ 不要禁用 selectionManager！
}
```

---

### 问题 4：鼠标输入被其他脚本吸收

#### 原因
- UI 挡住了射线
- 其他脚本优先处理了 `Input.GetMouseButtonDown(0)`

#### 修复方法

**方法 1：调整脚本执行顺序**
```
1. Edit → Project Settings → Script Execution Order
2. 将 CubeSelectionManager 设置为较早执行（例如 -100）
3. 将 ExtendInputManager 设置为较晚执行（例如 100）
```

**方法 2：UI 检测**
```csharp
// 在 CubeSelectionManager.TrySelectCube() 开头添加：
if (UnityEngine.EventSystems.EventSystem.current != null &&
    UnityEngine.EventSystems.EventSystem.current.IsPointerOverGameObject())
{
    Debug.Log("[Selection] 鼠标在 UI 上，跳过选择");
    return;
}
```

---

## 🧪 完整测试流程

### 1. 基础测试

```
1. 进入 Play 模式 ▶️
2. 点击一个 Cube（应该高亮）✅
3. 按 ESC 取消选择（高亮消失）✅
4. 再次点击同一个 Cube（应该能再次高亮）❓
5. 点击另一个 Cube（应该切换选择）❓
```

### 2. 日志测试

```
1. 启用 CubeSelectionManager.showDetailedLog
2. 清空 Console
3. 点击 Cube
4. 查看日志，确认完整流程
```

### 3. 诊断工具测试

```
1. 添加 SelectionDebugTool 到场景
2. 进入 Play 模式
3. 查看右上角诊断面板
4. 点击 Cube，查看 Console 输出的详细诊断
```

---

## 📊 诊断检查清单

### 必查项目

- [ ] `CubeSelectionManager` 组件已添加且已启用
- [ ] `ExtendInputManager` 组件已添加且已启用
- [ ] 场景中有 Proxy GameObject（搜索 "Proxy_"）
- [ ] Proxy GameObject 已激活
- [ ] Proxy 有 `BoxCollider` 且 `Is Trigger = false`
- [ ] Proxy 的 Layer 在 `interactableLayer` 中
- [ ] 主相机存在且未被禁用

### 进阶检查

- [ ] Entity 数量正常（未被意外销毁）
- [ ] Proxy 的 `linkedEntity` 有效
- [ ] 没有 UI 挡住射线
- [ ] 脚本执行顺序正确
- [ ] 没有其他脚本吸收输入

---

## 🚀 快速修复指令

如果你仍然无法定位问题，尝试以下**重置操作**：

### 重置 1：重新生成 Proxy

```csharp
// 1. 停止 Play 模式
// 2. 删除所有 Proxy（Hierarchy 搜索 "Proxy_" → 全选 → Delete）
// 3. 重新进入 Play 模式
// 4. InteractableProxySpawnSystem 会自动重新生成 Proxy
```

### 重置 2：清空选择状态

```csharp
// 在 CubeSelectionManager.Start() 中添加：
void Start()
{
    // ... 原有代码 ...
    
    // 强制清空所有选择状态
    var query = _entityManager.CreateEntityQuery(typeof(SelectionState));
    _entityManager.SetComponentData(query, new SelectionState { IsSelected = 0 });
    query.Dispose();
}
```

---

## 💡 预防措施

### 最佳实践

1. **不要手动销毁 Proxy**：Proxy 由系统自动管理
2. **不要禁用 `CubeSelectionManager`**：只禁用 `playerController`
3. **正确设置 Layer**：使用专用的 "Interactable" Layer
4. **脚本执行顺序**：`CubeSelectionManager` 应该较早执行

### 代码规范

```csharp
// ✅ 正确：只禁用移动
playerController.enabled = false;

// ❌ 错误：禁用选择管理器
selectionManager.enabled = false;

// ✅ 正确：使用专用 Layer
interactableLayer = LayerMask.GetMask("Interactable");

// ❌ 错误：使用 Everything（会命中所有物体）
interactableLayer = ~0;
```

---

## 📞 仍然无法解决？

### 提供以下信息

1. **Console 完整日志**（启用 `showDetailedLog`）
2. **Hierarchy 截图**（搜索 "Proxy_"）
3. **`CubeSelectionManager` Inspector 截图**
4. **`SelectionDebugTool` 输出**

### 临时 Workaround

如果问题仍未解决，可以尝试以下临时方案：

```csharp
// 在 CubeSelectionManager.Update() 的开头添加强制刷新：
void Update()
{
    // 强制刷新 EntityManager（临时方案）
    if (_entityManager == null || !_entityManager.IsCreated)
    {
        _entityManager = World.DefaultGameObjectInjectionWorld.EntityManager;
    }
    
    // ... 原有代码 ...
}
```

---

## ✅ 问题解决确认

测试以下场景，全部通过表示问题已解决：

- [ ] 能选中第一个 Cube
- [ ] ESC 取消选择后，能再次选中
- [ ] 能选中不同的 Cube
- [ ] 连续选择 10 次以上无问题
- [ ] 没有异常日志
- [ ] Proxy 数量稳定（不增不减）

---

**诊断时间**：2025-10-24
**相关文件**：
- `CubeSelectionManager.cs`
- `ExtendInputManager.cs`
- `SelectionDebugTool.cs`
- `InteractableProxySpawnSystem.cs`


# é€‰ä¸­å¤±æ•ˆé—®é¢˜è¯Šæ–­æŒ‡å—

## ğŸ› é—®é¢˜æè¿°

**ç—‡çŠ¶**ï¼šé€‰ä¸­ä¸€æ¬¡ Cube åï¼Œé€€å‡ºé€‰æ‹©ï¼ˆESC/å³é”®ï¼‰ï¼Œä¹‹åæ— æ³•å†æ¬¡é€‰ä¸­ä»»ä½• Cubeã€‚

---

## ğŸ” å¯èƒ½åŸå› åˆ†æ

### 1. ç»„ä»¶è¢«ç¦ç”¨
- `CubeSelectionManager` è„šæœ¬è¢«ç¦ç”¨
- `InteractableProxy` GameObject è¢«ç¦ç”¨
- ä¸»ç›¸æœºä¸¢å¤±

### 2. Entity è¢«é”€æ¯
- é€‰ä¸­çš„ Entity è¢«ç³»ç»Ÿé”€æ¯
- ä»£ç†é“¾æ¥çš„ Entity æ— æ•ˆ

### 3. è¾“å…¥è¢«æ‹¦æˆª
- å…¶ä»–è„šæœ¬å¸æ”¶äº†é¼ æ ‡è¾“å…¥
- UI é˜»æŒ¡äº†å°„çº¿æ£€æµ‹

### 4. Layer è®¾ç½®é—®é¢˜
- Proxy GameObject çš„ Layer ä¸åœ¨ `interactableLayer` ä¸­
- Raycast Layer Mask è®¾ç½®é”™è¯¯

### 5. è„šæœ¬æ‰§è¡Œé¡ºåºé—®é¢˜
- `ExtendInputManager` ä¸ `CubeSelectionManager` æ‰§è¡Œé¡ºåºå†²çª

---

## ğŸ› ï¸ è¯Šæ–­æ­¥éª¤

### æ­¥éª¤ 1ï¼šæ·»åŠ è¯Šæ–­å·¥å…·

1. **æ‰¾åˆ°åœºæ™¯ä¸­çš„ç©º GameObject**ï¼ˆæˆ–åˆ›å»ºä¸€ä¸ªæ–°çš„ï¼‰
2. **æ·»åŠ  `SelectionDebugTool` ç»„ä»¶**ï¼š
   ```
   GameObject â†’ Create Empty
   Add Component â†’ Selection Debug Tool
   ```
3. **è¿›å…¥ Play æ¨¡å¼**
4. **æŸ¥çœ‹å³ä¸Šè§’çš„è¯Šæ–­é¢æ¿**

### æ­¥éª¤ 2ï¼šå¯ç”¨è¯¦ç»†æ—¥å¿—

1. **æ‰¾åˆ°åœºæ™¯ä¸­çš„ `CubeSelectionManager` ç»„ä»¶**
2. **å‹¾é€‰ `Show Detailed Log`**
3. **è¿›å…¥ Play æ¨¡å¼ï¼Œç‚¹å‡» Cube**
4. **æŸ¥çœ‹ Console è¾“å‡º**

#### æ­£å¸¸è¾“å‡ºç¤ºä¾‹ï¼š
```
[Selection] æ£€æµ‹åˆ°é¼ æ ‡å·¦é”®ç‚¹å‡»
[Selection] å°„çº¿: èµ·ç‚¹=(0, 1, 0), æ–¹å‘=(0.5, -0.2, 0.8)
[Selection] å°„çº¿å‘½ä¸­: Proxy_Entity(123:1), è·ç¦»=5.23
[Selection] æ‰¾åˆ°ä»£ç†: Entity=Entity(123:1)
[Selection] âœ… é€‰ä¸­ Cubeï¼šEntity=Entity(123:1), Type=Extendable
```

#### å¼‚å¸¸è¾“å‡ºç¤ºä¾‹ï¼š
```
[Selection] æ£€æµ‹åˆ°é¼ æ ‡å·¦é”®ç‚¹å‡»
[Selection] å°„çº¿æœªå‘½ä¸­ä»»ä½•ç‰©ä½“ï¼Œå–æ¶ˆé€‰æ‹©  âŒ é—®é¢˜ï¼šå°„çº¿æ²¡å‘½ä¸­
```

æˆ–

```
[Selection] å°„çº¿å‘½ä¸­: TestCube, è·ç¦»=3.45
[Selection] âš ï¸ å‘½ä¸­ç‰©ä½“ä½†æ— ä»£ç†ç»„ä»¶: TestCube  âŒ é—®é¢˜ï¼šæ²¡æœ‰ä»£ç†
```

---

## ğŸ”§ å¸¸è§é—®é¢˜ä¿®å¤

### é—®é¢˜ 1ï¼šå°„çº¿æœªå‘½ä¸­ä»»ä½•ç‰©ä½“

#### åŸå› 
- Proxy GameObject è¢«ç¦ç”¨
- Proxy Collider è¢«ç¦ç”¨æˆ–åˆ é™¤
- Layer è®¾ç½®é”™è¯¯

#### ä¿®å¤æ–¹æ³•

**æ£€æŸ¥ 1ï¼šæŸ¥çœ‹ Proxy æ˜¯å¦å­˜åœ¨**
```
1. è¿›å…¥ Play æ¨¡å¼
2. Hierarchy æœç´¢ "Proxy_"
3. æŸ¥çœ‹æ˜¯å¦æœ‰ Proxy GameObject
4. æ£€æŸ¥æ˜¯å¦æ¿€æ´»ï¼ˆåç§°å‰æœ‰å‹¾é€‰æ¡†ï¼‰
```

**æ£€æŸ¥ 2ï¼šæŸ¥çœ‹ Collider**
```
1. é€‰ä¸­ä»»æ„ Proxy_XXX GameObject
2. æ£€æŸ¥ Inspector ä¸­æ˜¯å¦æœ‰ Box Collider ç»„ä»¶
3. ç¡®è®¤ Box Collider çš„ "Enabled" å·²å‹¾é€‰
4. ç¡®è®¤ "Is Trigger" æœªå‹¾é€‰ï¼ˆå¿…é¡»ä¸º falseï¼‰
```

**æ£€æŸ¥ 3ï¼šæŸ¥çœ‹ Layer**
```
1. é€‰ä¸­ Proxy GameObject
2. æŸ¥çœ‹ Inspector é¡¶éƒ¨çš„ "Layer" è®¾ç½®
3. æ‰¾åˆ° CubeSelectionManager ç»„ä»¶
4. ç¡®è®¤ Proxy çš„ Layer åœ¨ "Interactable Layer" ä¸­
```

**å¿«é€Ÿä¿®å¤**ï¼š
```
1. é€‰ä¸­æ‰€æœ‰ Proxy GameObjectï¼ˆæœç´¢ "Proxy_"ï¼‰
2. Inspector é¡¶éƒ¨ Layer â†’ Default
3. CubeSelectionManager â†’ Interactable Layer â†’ Everythingï¼ˆä¸´æ—¶æµ‹è¯•ï¼‰
```

---

### é—®é¢˜ 2ï¼šå‘½ä¸­ç‰©ä½“ä½†æ— ä»£ç†ç»„ä»¶

#### åŸå› 
- å°„çº¿å‘½ä¸­äº†é”™è¯¯çš„ç‰©ä½“ï¼ˆä¾‹å¦‚åœ°é¢ã€å¢™å£ï¼‰
- Cube çš„ç¢°æ’ä½“ä¼˜å…ˆçº§é«˜äº Proxy

#### ä¿®å¤æ–¹æ³•

**æ–¹æ³• 1ï¼šè°ƒæ•´ Layer è®¾ç½®**
```
1. å°†æ‰€æœ‰éäº¤äº’ç‰©ä½“ï¼ˆåœ°é¢ã€å¢™å£ï¼‰è®¾ç½®ä¸º "Terrain" Layer
2. CubeSelectionManager â†’ Interactable Layer â†’ å–æ¶ˆå‹¾é€‰ "Terrain"
3. ç¡®ä¿åªæœ‰ Proxy å¯ä»¥è¢«å°„çº¿å‘½ä¸­
```

**æ–¹æ³• 2ï¼šç¦ç”¨ Cube Entity çš„ç¢°æ’**
```
å¦‚æœ Cube Entity è‡ªå·±æœ‰ BoxColliderï¼ˆç”¨äºç‰©ç†ç¢°æ’ï¼‰ï¼Œ
å¯èƒ½ä¼šä¼˜å…ˆè¢«å°„çº¿å‘½ä¸­ã€‚è§£å†³æ–¹æ¡ˆï¼š

1. ä¸º Proxy å•ç‹¬è®¾ç½®ä¸€ä¸ª Layerï¼ˆä¾‹å¦‚ "Interactable"ï¼‰
2. åªåœ¨è¿™ä¸ª Layer ä¸Šè¿›è¡Œå°„çº¿æ£€æµ‹
```

---

### é—®é¢˜ 3ï¼šç¬¬ä¸€æ¬¡èƒ½é€‰ä¸­ï¼Œç¬¬äºŒæ¬¡ä¸è¡Œ

#### åŸå›  Aï¼šProxy è¢«é”€æ¯

**æ£€æŸ¥**ï¼š
```
1. é€‰ä¸­ä¸€æ¬¡ Cube
2. æŒ‰ ESC å–æ¶ˆé€‰æ‹©
3. Hierarchy ä¸­æœç´¢ "Proxy_"
4. æŸ¥çœ‹ Proxy æ•°é‡æ˜¯å¦å‡å°‘
```

**ä¿®å¤**ï¼š
æ£€æŸ¥æ˜¯å¦æœ‰ç³»ç»Ÿåœ¨é”€æ¯ Proxyã€‚æŸ¥çœ‹ `InteractableProxySpawnSystem.cs` æ˜¯å¦æœ‰é”€æ¯é€»è¾‘ã€‚

#### åŸå›  Bï¼šEntity è¢«é”€æ¯

**æ£€æŸ¥**ï¼š
```
1. å¯ç”¨ `CubeSelectionManager.showDetailedLog`
2. ç¬¬äºŒæ¬¡ç‚¹å‡»æ—¶æŸ¥çœ‹æ—¥å¿—
3. å¦‚æœæ˜¾ç¤º "ä»£ç†çš„ linkedEntity ä¸ºç©º"ï¼Œè¯´æ˜ Entity è¢«é”€æ¯
```

**ä¿®å¤**ï¼š
æ£€æŸ¥ `ExtendExecutionSystem.cs` æˆ–å…¶ä»–ç³»ç»Ÿæ˜¯å¦é”€æ¯äº†åŸå§‹ Entityã€‚

#### åŸå›  Cï¼šç»„ä»¶è¢«ç¦ç”¨

**æ£€æŸ¥**ï¼š
```
1. é€‰ä¸­åœºæ™¯ä¸­çš„ CubeSelectionManager GameObject
2. ç¡®è®¤ Inspector ä¸­ CubeSelectionManager è„šæœ¬çš„å‹¾é€‰æ¡†å·²å‹¾é€‰
3. ç¡®è®¤ GameObject æœ¬èº«å·²æ¿€æ´»
```

**ä¿®å¤**ï¼š
```csharp
// å¦‚æœ ExtendInputManager ç¦ç”¨äº† CubeSelectionManagerï¼Œæ£€æŸ¥ä»£ç ï¼š
if (autoDisableMovement && playerController != null)
{
    playerController.enabled = false; // âœ… åªç¦ç”¨ playerController
    // selectionManager.enabled = false; // âŒ ä¸è¦ç¦ç”¨ selectionManagerï¼
}
```

---

### é—®é¢˜ 4ï¼šé¼ æ ‡è¾“å…¥è¢«å…¶ä»–è„šæœ¬å¸æ”¶

#### åŸå› 
- UI æŒ¡ä½äº†å°„çº¿
- å…¶ä»–è„šæœ¬ä¼˜å…ˆå¤„ç†äº† `Input.GetMouseButtonDown(0)`

#### ä¿®å¤æ–¹æ³•

**æ–¹æ³• 1ï¼šè°ƒæ•´è„šæœ¬æ‰§è¡Œé¡ºåº**
```
1. Edit â†’ Project Settings â†’ Script Execution Order
2. å°† CubeSelectionManager è®¾ç½®ä¸ºè¾ƒæ—©æ‰§è¡Œï¼ˆä¾‹å¦‚ -100ï¼‰
3. å°† ExtendInputManager è®¾ç½®ä¸ºè¾ƒæ™šæ‰§è¡Œï¼ˆä¾‹å¦‚ 100ï¼‰
```

**æ–¹æ³• 2ï¼šUI æ£€æµ‹**
```csharp
// åœ¨ CubeSelectionManager.TrySelectCube() å¼€å¤´æ·»åŠ ï¼š
if (UnityEngine.EventSystems.EventSystem.current != null &&
    UnityEngine.EventSystems.EventSystem.current.IsPointerOverGameObject())
{
    Debug.Log("[Selection] é¼ æ ‡åœ¨ UI ä¸Šï¼Œè·³è¿‡é€‰æ‹©");
    return;
}
```

---

## ğŸ§ª å®Œæ•´æµ‹è¯•æµç¨‹

### 1. åŸºç¡€æµ‹è¯•

```
1. è¿›å…¥ Play æ¨¡å¼ â–¶ï¸
2. ç‚¹å‡»ä¸€ä¸ª Cubeï¼ˆåº”è¯¥é«˜äº®ï¼‰âœ…
3. æŒ‰ ESC å–æ¶ˆé€‰æ‹©ï¼ˆé«˜äº®æ¶ˆå¤±ï¼‰âœ…
4. å†æ¬¡ç‚¹å‡»åŒä¸€ä¸ª Cubeï¼ˆåº”è¯¥èƒ½å†æ¬¡é«˜äº®ï¼‰â“
5. ç‚¹å‡»å¦ä¸€ä¸ª Cubeï¼ˆåº”è¯¥åˆ‡æ¢é€‰æ‹©ï¼‰â“
```

### 2. æ—¥å¿—æµ‹è¯•

```
1. å¯ç”¨ CubeSelectionManager.showDetailedLog
2. æ¸…ç©º Console
3. ç‚¹å‡» Cube
4. æŸ¥çœ‹æ—¥å¿—ï¼Œç¡®è®¤å®Œæ•´æµç¨‹
```

### 3. è¯Šæ–­å·¥å…·æµ‹è¯•

```
1. æ·»åŠ  SelectionDebugTool åˆ°åœºæ™¯
2. è¿›å…¥ Play æ¨¡å¼
3. æŸ¥çœ‹å³ä¸Šè§’è¯Šæ–­é¢æ¿
4. ç‚¹å‡» Cubeï¼ŒæŸ¥çœ‹ Console è¾“å‡ºçš„è¯¦ç»†è¯Šæ–­
```

---

## ğŸ“Š è¯Šæ–­æ£€æŸ¥æ¸…å•

### å¿…æŸ¥é¡¹ç›®

- [ ] `CubeSelectionManager` ç»„ä»¶å·²æ·»åŠ ä¸”å·²å¯ç”¨
- [ ] `ExtendInputManager` ç»„ä»¶å·²æ·»åŠ ä¸”å·²å¯ç”¨
- [ ] åœºæ™¯ä¸­æœ‰ Proxy GameObjectï¼ˆæœç´¢ "Proxy_"ï¼‰
- [ ] Proxy GameObject å·²æ¿€æ´»
- [ ] Proxy æœ‰ `BoxCollider` ä¸” `Is Trigger = false`
- [ ] Proxy çš„ Layer åœ¨ `interactableLayer` ä¸­
- [ ] ä¸»ç›¸æœºå­˜åœ¨ä¸”æœªè¢«ç¦ç”¨

### è¿›é˜¶æ£€æŸ¥

- [ ] Entity æ•°é‡æ­£å¸¸ï¼ˆæœªè¢«æ„å¤–é”€æ¯ï¼‰
- [ ] Proxy çš„ `linkedEntity` æœ‰æ•ˆ
- [ ] æ²¡æœ‰ UI æŒ¡ä½å°„çº¿
- [ ] è„šæœ¬æ‰§è¡Œé¡ºåºæ­£ç¡®
- [ ] æ²¡æœ‰å…¶ä»–è„šæœ¬å¸æ”¶è¾“å…¥

---

## ğŸš€ å¿«é€Ÿä¿®å¤æŒ‡ä»¤

å¦‚æœä½ ä»ç„¶æ— æ³•å®šä½é—®é¢˜ï¼Œå°è¯•ä»¥ä¸‹**é‡ç½®æ“ä½œ**ï¼š

### é‡ç½® 1ï¼šé‡æ–°ç”Ÿæˆ Proxy

```csharp
// 1. åœæ­¢ Play æ¨¡å¼
// 2. åˆ é™¤æ‰€æœ‰ Proxyï¼ˆHierarchy æœç´¢ "Proxy_" â†’ å…¨é€‰ â†’ Deleteï¼‰
// 3. é‡æ–°è¿›å…¥ Play æ¨¡å¼
// 4. InteractableProxySpawnSystem ä¼šè‡ªåŠ¨é‡æ–°ç”Ÿæˆ Proxy
```

### é‡ç½® 2ï¼šæ¸…ç©ºé€‰æ‹©çŠ¶æ€

```csharp
// åœ¨ CubeSelectionManager.Start() ä¸­æ·»åŠ ï¼š
void Start()
{
    // ... åŸæœ‰ä»£ç  ...
    
    // å¼ºåˆ¶æ¸…ç©ºæ‰€æœ‰é€‰æ‹©çŠ¶æ€
    var query = _entityManager.CreateEntityQuery(typeof(SelectionState));
    _entityManager.SetComponentData(query, new SelectionState { IsSelected = 0 });
    query.Dispose();
}
```

---

## ğŸ’¡ é¢„é˜²æªæ–½

### æœ€ä½³å®è·µ

1. **ä¸è¦æ‰‹åŠ¨é”€æ¯ Proxy**ï¼šProxy ç”±ç³»ç»Ÿè‡ªåŠ¨ç®¡ç†
2. **ä¸è¦ç¦ç”¨ `CubeSelectionManager`**ï¼šåªç¦ç”¨ `playerController`
3. **æ­£ç¡®è®¾ç½® Layer**ï¼šä½¿ç”¨ä¸“ç”¨çš„ "Interactable" Layer
4. **è„šæœ¬æ‰§è¡Œé¡ºåº**ï¼š`CubeSelectionManager` åº”è¯¥è¾ƒæ—©æ‰§è¡Œ

### ä»£ç è§„èŒƒ

```csharp
// âœ… æ­£ç¡®ï¼šåªç¦ç”¨ç§»åŠ¨
playerController.enabled = false;

// âŒ é”™è¯¯ï¼šç¦ç”¨é€‰æ‹©ç®¡ç†å™¨
selectionManager.enabled = false;

// âœ… æ­£ç¡®ï¼šä½¿ç”¨ä¸“ç”¨ Layer
interactableLayer = LayerMask.GetMask("Interactable");

// âŒ é”™è¯¯ï¼šä½¿ç”¨ Everythingï¼ˆä¼šå‘½ä¸­æ‰€æœ‰ç‰©ä½“ï¼‰
interactableLayer = ~0;
```

---

## ğŸ“ ä»ç„¶æ— æ³•è§£å†³ï¼Ÿ

### æä¾›ä»¥ä¸‹ä¿¡æ¯

1. **Console å®Œæ•´æ—¥å¿—**ï¼ˆå¯ç”¨ `showDetailedLog`ï¼‰
2. **Hierarchy æˆªå›¾**ï¼ˆæœç´¢ "Proxy_"ï¼‰
3. **`CubeSelectionManager` Inspector æˆªå›¾**
4. **`SelectionDebugTool` è¾“å‡º**

### ä¸´æ—¶ Workaround

å¦‚æœé—®é¢˜ä»æœªè§£å†³ï¼Œå¯ä»¥å°è¯•ä»¥ä¸‹ä¸´æ—¶æ–¹æ¡ˆï¼š

```csharp
// åœ¨ CubeSelectionManager.Update() çš„å¼€å¤´æ·»åŠ å¼ºåˆ¶åˆ·æ–°ï¼š
void Update()
{
    // å¼ºåˆ¶åˆ·æ–° EntityManagerï¼ˆä¸´æ—¶æ–¹æ¡ˆï¼‰
    if (_entityManager == null || !_entityManager.IsCreated)
    {
        _entityManager = World.DefaultGameObjectInjectionWorld.EntityManager;
    }
    
    // ... åŸæœ‰ä»£ç  ...
}
```

---

## âœ… é—®é¢˜è§£å†³ç¡®è®¤

æµ‹è¯•ä»¥ä¸‹åœºæ™¯ï¼Œå…¨éƒ¨é€šè¿‡è¡¨ç¤ºé—®é¢˜å·²è§£å†³ï¼š

- [ ] èƒ½é€‰ä¸­ç¬¬ä¸€ä¸ª Cube
- [ ] ESC å–æ¶ˆé€‰æ‹©åï¼Œèƒ½å†æ¬¡é€‰ä¸­
- [ ] èƒ½é€‰ä¸­ä¸åŒçš„ Cube
- [ ] è¿ç»­é€‰æ‹© 10 æ¬¡ä»¥ä¸Šæ— é—®é¢˜
- [ ] æ²¡æœ‰å¼‚å¸¸æ—¥å¿—
- [ ] Proxy æ•°é‡ç¨³å®šï¼ˆä¸å¢ä¸å‡ï¼‰

---

**è¯Šæ–­æ—¶é—´**ï¼š2025-10-24
**ç›¸å…³æ–‡ä»¶**ï¼š
- `CubeSelectionManager.cs`
- `ExtendInputManager.cs`
- `SelectionDebugTool.cs`
- `InteractableProxySpawnSystem.cs`


# 选中失效 - 快速解决方案

## 🚀 5 分钟快速修复

### 步骤 1：添加诊断工具（30 秒）

```
1. Hierarchy → Create Empty → 命名为 "SelectionTools"
2. Add Component → "Selection Debug Tool"
3. Add Component → "Selection Auto Fix"
```

### 步骤 2：进入 Play 模式（10 秒）

```
1. 点击 ▶️ Play
2. 查看右下角和右上角的调试面板
```

### 步骤 3：执行自动修复（10 秒）

```
1. 点击右下角的 "执行完整修复" 按钮
2. 查看 Console 输出
```

### 步骤 4：验证设置（10 秒）

```
1. 点击右下角的 "验证设置" 按钮
2. 检查 Console 输出，查看是否有 ❌ 标记
```

### 步骤 5：测试选择（30 秒）

```
1. 点击一个 Cube（应该高亮）
2. 按 ESC 取消
3. 再次点击同一个 Cube
4. 重复 5-10 次
```

---

## 🎯 最常见的 3 个问题及修复

### 问题 1：Layer Mask 设置错误 ⚠️

#### 症状
```
[Selection] 射线未命中任何物体，取消选择
```

#### 快速修复
```
1. 找到场景中的 CubeSelectionManager 组件
2. 展开 "Interactable Layer"
3. 勾选 "Everything"（或至少 "Default"）
4. 点击右下角的 "执行完整修复"
```

---

### 问题 2：Proxy 未激活 ⚠️

#### 症状
```
代理数量: 10
激活代理: 0  ❌ 全部未激活！
```

#### 快速修复
```
1. Hierarchy 搜索 "Proxy_"
2. 选中所有 Proxy GameObject
3. Inspector 顶部勾选框 → 确保已勾选
```

或使用脚本修复：

```csharp
// 在 SelectionAutoFix.cs 的 CheckProxyActiveState() 中取消注释：
proxy.gameObject.SetActive(true);
```

---

### 问题 3：Collider 是 Trigger ⚠️

#### 症状
```
射线命中: Proxy_XXX
⚠️ 命中物体但无代理组件
```

#### 快速修复
```
1. Hierarchy 搜索 "Proxy_"
2. 选中任意一个 Proxy
3. Inspector → Box Collider → 确认 "Is Trigger" 未勾选（必须为 false）
```

---

## 🔍 高级诊断（2 分钟）

### 启用详细日志

```
1. 找到 CubeSelectionManager 组件
2. 勾选 "Show Detailed Log"
3. 进入 Play 模式
4. 点击 Cube
5. 查看 Console 完整输出
```

### 正常输出示例

```
[Selection] 初始化成功
[Selection] 检测到鼠标左键点击
[Selection] 射线: 起点=(0, 1.6, 0), 方向=(0.5, -0.3, 0.8)
[Selection] 射线命中: Proxy_Entity(123:1), 距离=3.45
[Selection] 找到代理: Entity=Entity(123:1)
[Selection] ✅ Entity 有 Emission 组件
[Selection] ✅ 选中 Cube：Entity=Entity(123:1), Type=Extendable
```

### 异常输出示例

#### 情况 A：射线未命中
```
[Selection] 射线未命中任何物体，取消选择  ❌
```
**原因**：Layer Mask 问题或 Proxy 未激活  
**修复**：执行"问题 1"或"问题 2"的修复步骤

#### 情况 B：命中但无代理
```
[Selection] 射线命中: TestCube, 距离=2.50
[Selection] ⚠️ 命中物体但无代理组件  ❌
```
**原因**：射线命中了其他物体（地面、墙壁）  
**修复**：调整 Layer Mask，只选择 Proxy 的 Layer

#### 情况 C：代理 Entity 为空
```
[Selection] ⚠️ 代理的 linkedEntity 为空  ❌
```
**原因**：Entity 被销毁或未正确链接  
**修复**：点击"重置选择状态"，重新进入 Play 模式

---

## 📋 完整检查清单

### 运行前检查

- [ ] 场景中有 `CubeSelectionManager` 组件
- [ ] 场景中有 `ExtendInputManager` 组件
- [ ] 场景中有至少一个 `StageManager` 或 `CubeLayoutSpawnerAuthoring`
- [ ] 已创建 `CubeLayout` 资产并添加了 Cube
- [ ] Cube Prefab 有正确的材质（支持 Emission）

### 运行时检查

- [ ] Hierarchy 中有 `Proxy_` GameObject（搜索确认）
- [ ] Proxy 数量 > 0
- [ ] Proxy 激活状态：是
- [ ] Proxy 有 Box Collider 且 Is Trigger = false
- [ ] Console 无 Error 或 Warning

### 测试检查

- [ ] 能选中第一个 Cube
- [ ] 高亮效果正常（黄色脉冲）
- [ ] 按 ESC 取消后高亮消失
- [ ] 能再次选中同一个 Cube
- [ ] 能选中不同的 Cube
- [ ] 连续测试 10 次无问题

---

## 🆘 仍然无法解决？

### 终极重置方案

```
1. 停止 Play 模式
2. 删除所有 Proxy GameObject（搜索 "Proxy_" → 全选 → Delete）
3. 清空 Console
4. 重新进入 Play 模式
5. 等待 3 秒（让系统重新生成 Proxy）
6. 点击 "验证设置" 按钮
7. 测试选择功能
```

### 提供日志进行分析

如果问题仍然存在，请提供以下信息：

1. **Console 完整日志**（启用 `showDetailedLog`）
   ```
   1. 清空 Console
   2. 点击 Cube 1 次
   3. 复制所有日志
   ```

2. **验证设置输出**
   ```
   1. 点击 "验证设置" 按钮
   2. 复制 Console 输出
   ```

3. **Hierarchy 截图**
   ```
   1. 搜索 "Proxy_"
   2. 截图显示所有 Proxy
   ```

4. **Inspector 截图**
   ```
   1. 选中 CubeSelectionManager GameObject
   2. 截图显示所有设置
   ```

---

## 🎉 成功案例

### 用户 A：Layer Mask 问题

**问题**：第二次点击无反应

**原因**：`interactableLayer` 设置为 `Nothing`

**修复**：
```
CubeSelectionManager → Interactable Layer → Everything
```

**结果**：✅ 问题解决，可以正常选择

---

### 用户 B：Proxy 未激活

**问题**：第一次选中后，Proxy 消失

**原因**：某个脚本在取消选择时禁用了 Proxy

**修复**：
```
检查所有脚本，移除了错误的 proxy.gameObject.SetActive(false) 代码
```

**结果**：✅ Proxy 保持激活，选择正常

---

### 用户 C：Entity 被销毁

**问题**：第一次选中后，Entity 无效

**原因**：拉伸系统意外销毁了原始 Entity

**修复**：
```
修改 ExtendExecutionSystem，不销毁原始 Entity
```

**结果**：✅ Entity 保持有效，选择正常

---

## 💡 预防措施

### 最佳实践

1. **使用专用 Layer**
   ```
   1. Edit → Project Settings → Tags and Layers
   2. 添加 "Interactable" Layer
   3. 所有 Proxy 设置为该 Layer
   4. CubeSelectionManager 只检测该 Layer
   ```

2. **不要手动禁用/销毁 Proxy**
   ```
   // ❌ 错误
   proxy.gameObject.SetActive(false);
   Destroy(proxy.gameObject);
   
   // ✅ 正确：由系统自动管理
   ```

3. **脚本执行顺序**
   ```
   Edit → Project Settings → Script Execution Order:
   - CubeSelectionManager: -100（较早执行）
   - ExtendInputManager: 0（默认）
   ```

---

## 📞 联系支持

如果以上方法都无法解决问题，请提供：

1. Unity 版本
2. DOTS/Entities 版本
3. 完整日志（启用 `showDetailedLog`）
4. Hierarchy 截图
5. CubeSelectionManager 设置截图

---

**创建时间**：2025-10-24  
**相关文件**：
- `CubeSelectionManager.cs`（已添加详细日志）
- `SelectionDebugTool.cs`（诊断工具）
- `SelectionAutoFix.cs`（自动修复）
- `选中失效问题诊断指南.md`（完整文档）


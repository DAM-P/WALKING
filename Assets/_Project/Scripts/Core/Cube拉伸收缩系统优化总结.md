# Cube拉伸收缩系统优化总结

## 📋 优化概述

本次优化将cube操控系统从"解谜游戏式"改为"跑酷游戏式"，核心改进：**用鼠标实现快速直观的拉伸收缩操作**。

**优化日期**：2025-10-26  
**版本**：v2.0

---

## ✨ 主要改进

### 1. 🖱️ 鼠标拖拽拉伸系统
- **新增文件**：`MouseDragExtendManager.cs`
- **操作方式**：点击选中 → 拖拽拉伸 → 松开确认
- **优势**：
  - 单手操作，不占用WASD
  - 所见即所得，拖拽距离即拉伸长度
  - 快速响应，适合跑酷节奏

### 2. 🔄 收缩系统
- **新增文件**：`RetractSystem.cs`
- **操作方式**：右键点击已拉伸cube → 收缩整条链
- **功能**：
  - 快速回收cube
  - 自动清理碰撞体
  - 更新空间哈希表

### 3. 🎨 增强预览效果
- **优化文件**：`ExtendPreviewSystem.cs`
- **改进**：
  - 双层线框，更醒目
  - 加粗连接线
  - 增强方向箭头
  - 更明显的绿色/红色区分

### 4. 🎮 跑酷模式协调器
- **优化文件**：`InputModeCoordinator.cs`
- **新增功能**：
  - 支持鼠标拖拽和键盘拉伸双模式
  - 跑酷模式：拉伸时允许继续移动
  - 智能检测使用哪种输入系统

---

## 📂 新增/修改文件清单

### 新增文件
```
_Project/Scripts/Core/
├── Authoring/Extend/
│   ├── MouseDragExtendManager.cs ⭐ (主要新增)
│   └── MouseDragExtendManager.cs.meta
├── Systems/Extend/
│   ├── RetractSystem.cs ⭐ (收缩系统)
│   └── RetractSystem.cs.meta
├── 鼠标拖拽拉伸系统使用指南.md 📖
└── Cube拉伸收缩系统优化总结.md 📖 (本文档)
```

### 修改文件
```
_Project/Scripts/Core/
├── Systems/Extend/
│   └── ExtendPreviewSystem.cs (增强预览效果)
└── Authoring/Tools/AutoFix/
    └── InputModeCoordinator.cs (支持双输入模式)
```

---

## 🎮 操作对比

| 操作 | 旧系统（键盘） | 新系统（鼠标拖拽） |
|------|----------------|-------------------|
| **选择cube** | 左键点击 | 左键点击 ✅ |
| **选择方向** | 按WASD/方向键 | 拖拽方向自动对齐 ⚡ |
| **设置长度** | 按住时间控制 | 拖拽距离控制 ⚡ |
| **确认操作** | 松开按键 | 松开鼠标 ✅ |
| **收缩cube** | ❌ 未实现 | 右键点击 ⭐ |
| **取消操作** | ESC | ESC / 右键空白 ✅ |
| **同时移动** | ❌ 不可以 | ✅ 可以（跑酷模式）⭐ |

---

## 🚀 使用方法

### 快速开始

#### 1. 添加组件到场景

在场景中找到或创建管理器GameObject：

```
GameObject: GameManagers
├── CubeSelectionManager (保留)
├── MouseDragExtendManager (新增) ⭐
├── InputModeCoordinator (更新)
└── ExtendInputManager (可选保留)
```

#### 2. 配置MouseDragExtendManager

在Inspector中设置：
- **Drag Threshold**: 20 （开始拖拽的最小距离）
- **Pixels Per Cube**: 30 （每30像素增加1个cube）
- **Max Extend Length**: 10 （最大拉伸长度）
- **Enable Retract**: ✅ （启用右键收缩）
- **Retract Whole Chain**: ✅ （收缩整条链）

#### 3. 配置InputModeCoordinator

在Inspector中设置：
- **Mouse Drag Extend Manager**: 拖入对应组件 ⭐
- **Parkour Mode**: ✅ （跑酷模式，允许边移动边拉伸）⭐
- **Allow Movement While Extending**: ✅ ⭐

#### 4. 测试

1. 运行游戏
2. 左键点击cube（选中）
3. 按住左键拖拽（预览）
4. 松开鼠标（确认拉伸）
5. 右键点击拉伸cube（收缩）

---

## ⚙️ 配置参数详解

### MouseDragExtendManager

#### 拖拽设置
| 参数 | 默认值 | 说明 | 建议值 |
|------|--------|------|--------|
| dragThreshold | 20像素 | 防止误触的最小拖拽距离 | 10-30 |
| pixelsPerCube | 30像素 | 拖拽灵敏度 | 20-50 |
| maxExtendLength | 10 | 最大拉伸长度 | 5-15 |
| minExtendLength | 1 | 最小拉伸长度 | 1 |

#### 方向对齐
| 参数 | 默认值 | 说明 |
|------|--------|------|
| snapToMainAxis | ✅ | 自动对齐到6轴向（推荐） |
| directionAngleThreshold | 30° | 方向判定阈值（预留） |

#### 收缩设置
| 参数 | 默认值 | 说明 |
|------|--------|------|
| enableRetract | ✅ | 启用右键收缩 |
| retractWholeChain | ✅ | 收缩整条链（推荐） |

#### 视觉反馈
| 参数 | 默认值 | 说明 |
|------|--------|------|
| showDragLine | ✅ | 显示拖拽轨迹线 |
| dragLineColor | 青色 | 拖拽线颜色 |

#### 调试
| 参数 | 默认值 | 说明 |
|------|--------|------|
| showDebugLog | ✅ | Console日志 |
| showDebugGUI | ✅ | 屏幕调试信息 |

---

## 🎯 跑酷模式说明

### 什么是跑酷模式？

**跑酷模式**允许玩家在拉伸cube的同时继续移动，非常适合快节奏的跑酷游戏。

### 启用方式

在 `InputModeCoordinator` 中：
- `Parkour Mode` = ✅
- `Allow Movement While Extending` = ✅
- `Mouse Drag Extend Manager` = 设置引用

### 模式对比

| 特性 | 解谜模式 | 跑酷模式 ⭐ |
|------|---------|------------|
| 拉伸时移动 | ❌ 禁用 | ✅ 允许 |
| 光标状态 | 显示 | 显示 |
| 输入方式 | 键盘或鼠标 | 鼠标（推荐） |
| 操作速度 | 慢，精确 | 快，流畅 |
| 适合场景 | 解谜关卡 | 跑酷关卡 |

---

## 🧪 测试建议

### 基础功能测试

- [ ] 能选中cube（高亮显示）
- [ ] 拖拽显示预览（绿色线框）
- [ ] 方向正确对齐到6轴
- [ ] 长度对应拖拽距离
- [ ] 碰撞检测正确（红色预示）
- [ ] 松开鼠标生成cube链
- [ ] 右键收缩cube链
- [ ] ESC取消选择

### 跑酷模式测试

- [ ] 选中cube时能继续移动（WASD）
- [ ] 边移动边拖拽拉伸
- [ ] 快速点击-拖拽-松开流畅
- [ ] 光标状态正确切换

### 性能测试

- [ ] 大量cube时帧率正常
- [ ] 预览没有卡顿
- [ ] 拉伸操作响应快速

---

## 🐛 常见问题

### Q1: 拖拽没反应
**解决方案**：
1. 检查 `MouseDragExtendManager` 是否启用
2. 检查 `Main Camera` 引用
3. 确认cube有 `InteractableCubeTag` 和 `ExtendableTag`
4. 检查是否超过 `dragThreshold`

### Q2: 拉伸时无法移动
**解决方案**：
1. 检查 `InputModeCoordinator.parkourMode` = ✅
2. 检查 `allowMovementWhileExtending` = ✅
3. 确认使用的是 `MouseDragExtendManager`（不是键盘系统）

### Q3: 右键收缩无效
**解决方案**：
1. 检查 `enableRetract` = ✅
2. 确认点击的是拉伸出的cube（有 `ExtendChainData`）
3. 检查 `RetractSystem` 是否在运行

### Q4: 方向不准确
**解决方案**：
1. 开启 `snapToMainAxis`
2. 调整相机角度（建议45度俯视）
3. 增加 `dragThreshold` 防止误触

### Q5: 与旧系统冲突
**解决方案**：
1. 禁用 `ExtendInputManager` 组件
2. 或在 `InputModeCoordinator` 中优先选择鼠标系统
3. 不要同时按键盘和拖拽鼠标

---

## 🔄 从旧系统迁移

### 步骤1：添加新组件
```
1. 在场景中找到 ExtendManagers GameObject
2. 添加 MouseDragExtendManager 组件
3. 暂时保留 ExtendInputManager
```

### 步骤2：配置新系统
```
1. 设置 MouseDragExtendManager 的参数（见上文）
2. 更新 InputModeCoordinator 引用
3. 启用 parkourMode
```

### 步骤3：测试
```
1. 测试鼠标拖拽是否正常
2. 测试右键收缩
3. 测试边移动边拉伸
```

### 步骤4：移除旧系统（可选）
```
1. 禁用 ExtendInputManager
2. 确认新系统完全正常后
3. 删除 ExtendInputManager 组件
```

---

## 📊 性能优化建议

### 1. 预览优化
- 限制最大预览长度（10个以内）
- 降低预览更新频率（30fps足够）
- 使用Burst编译碰撞检测Job

### 2. 拖拽优化
- 缓存选中entity，减少查询
- 使用事件驱动代替每帧查询
- 优化屏幕空间到世界空间转换

### 3. 收缩优化
- 批量销毁entity
- 异步清理碰撞体
- 使用对象池

---

## 🎨 视觉效果说明

### 预览效果（增强版）

| 元素 | 颜色 | 说明 |
|------|------|------|
| 可拉伸区域 | 🟢 绿色双层线框 | 可以安全拉伸 |
| 碰撞区域 | 🔴 红色线框 | 无法拉伸 |
| 方向箭头 | 🟡 黄色箭头 | 拉伸方向指示 |
| 拖拽线 | 🔵 青色线 | 鼠标拖拽轨迹 |
| 连接线 | 🟢/🔴 加粗线 | 连接各个cube |

### 屏幕调试信息

**左上角（MouseDragExtendManager）**：
- 选中状态
- 拖拽中/否
- 拉伸方向和长度
- 拖拽距离

**右下角（InputModeCoordinator）**：
- 当前模式（移动/拉伸）
- 输入类型（键盘/鼠标）
- 跑酷模式状态
- 光标状态
- 玩家移动状态

---

## 🚧 未来改进方向

### 短期（v2.1）
- [ ] 添加触觉反馈（手柄震动）
- [ ] 优化拖拽手感（缓动曲线）
- [ ] 添加音效反馈
- [ ] 逐个收缩模式

### 中期（v2.2）
- [ ] 预设形状快速生成
- [ ] 曲线拉伸（非直线）
- [ ] UI进度条和提示
- [ ] 关卡编辑器支持

### 长期（v3.0）
- [ ] 网络同步支持
- [ ] 多人协作拉伸
- [ ] 拉伸录制和回放
- [ ] AI辅助拉伸

---

## 📚 相关文档

- **鼠标拖拽拉伸系统使用指南.md** - 详细使用说明
- **拉伸系统技术架构.md** - ECS底层架构
- **拉伸系统快速开始.md** - 快速上手
- **输入系统模式切换指南.md** - 输入协调说明

---

## 💡 设计理念

### 为什么选择鼠标拖拽？

1. **直观性** ⭐
   - 所见即所得，拖拽距离=拉伸长度
   - 不需要记忆键位
   - 视觉反馈即时

2. **速度** ⚡
   - 单次操作完成方向+长度设置
   - 适合跑酷游戏的快节奏
   - 减少操作步骤

3. **舒适性** 👍
   - 单手操作
   - 不占用WASD移动键
   - 可边移动边操作

4. **精确性** 🎯
   - 拖拽距离精确控制长度
   - 自动对齐到主轴
   - 碰撞实时预览

### 与跑酷游戏的契合

- **动态操作**：边跑边拉伸，不中断节奏
- **快速决策**：所见即所得，快速判断
- **流畅体验**：最少操作步骤，最快响应
- **创造性**：自由组合移动和拉伸

---

## 🎯 推荐关卡设计

基于新系统的关卡设计建议：

### 教学关卡
```
目标：教会玩家鼠标操作
- 简单鸿沟，引导点击cube
- 提示拖拽方向
- 成功后引导收缩
时间：无限制
```

### 基础跑酷关卡
```
目标：熟悉边跑边拉伸
- 多个连续间隙
- 需要快速拉伸搭桥
- 收缩前面的cube回收资源
时间：30秒
```

### 进阶跑酷关卡
```
目标：精确控制和时机把握
- 狭窄空间，精确拉伸
- 移动平台，动态操作
- 多方向切换
时间：45秒
```

### 速通挑战关卡
```
目标：追求最快时间
- 复杂路线
- 多种解法
- 时间排行榜
时间：60秒内
```

---

## 📝 代码示例

### 手动触发拉伸（代码调用）

```csharp
// 获取管理器
var dragManager = FindObjectOfType<MouseDragExtendManager>();

// 模拟拖拽（不推荐，建议让玩家操作）
// 这里仅作演示
```

### 监听拉伸事件（扩展）

```csharp
// TODO: 未来版本可添加事件系统
// OnExtendStart, OnExtendComplete, OnRetract
```

---

## ⚠️ 注意事项

1. **兼容性**
   - Unity 2022.3+ LTS
   - DOTS 1.0+
   - URP (可选)

2. **性能考虑**
   - 预览长度不要超过10
   - 大量cube时注意优化
   - 建议使用对象池

3. **输入冲突**
   - 不要同时使用键盘和鼠标拉伸
   - 使用 `InputModeCoordinator` 协调

4. **移动控制**
   - 确保 `FirstPersonController.lockCursor = false`
   - 光标控制由协调器接管

---

## 🙏 反馈和建议

如有问题或建议，欢迎：
- 在项目中创建Issue
- 更新本文档
- 联系开发团队

---

## 📝 变更日志

### v2.0 (2025-10-26)
- ✨ 新增鼠标拖拽拉伸系统
- ✨ 新增收缩系统（右键）
- 🎨 增强预览效果
- 🎮 支持跑酷模式
- 📖 完善文档

### v1.0 (之前)
- ✅ 键盘拉伸系统
- ✅ 基础预览系统
- ✅ 选择系统

---

**文档版本**：v2.0  
**最后更新**：2025-10-26  
**作者**：AI Assistant  
**项目**：Cube Parkour（跑酷游戏）



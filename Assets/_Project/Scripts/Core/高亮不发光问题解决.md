# 🔥 高亮不发光问题解决

## 已修复的代码

✅ **`HighlightRenderSystem.cs`** - 添加了材质写入逻辑  
✅ **`CubeLayoutSpawnSystem.cs`** - 为可交互 Cube 添加 Emission 组件

---

## 🚨 必须检查的配置

### 1️⃣ 定义 `HAS_URP_MATERIAL_PROPERTY` 宏

**检查方法**：
1. `Edit > Project Settings > Player`
2. 切换到 `Other Settings` 面板
3. 找到 `Scripting Define Symbols`
4. 检查是否有 **`HAS_URP_MATERIAL_PROPERTY`**

**如果没有**：
- 点击输入框，添加 `HAS_URP_MATERIAL_PROPERTY`
- 按 `Enter` 或点击 `Apply`
- 等待 Unity 重新编译（必须！）

**重要**：没有这个宏，所有高亮代码都不会执行！

---

### 2️⃣ 检查 Cube 材质是否支持 Emission

**步骤**：
1. 找到你的 **Cube Prefab**
2. 选中 Prefab，查看 Inspector
3. 找到 `Mesh Renderer > Materials`
4. 点击 Material

**检查材质**：
- Shader 必须支持 Emission（如 `Universal Render Pipeline/Lit`）
- Inspector 中应该有 **`Emission`** 区块
- 如果没有，切换 Shader：
  - Shader 下拉菜单
  - 选择 `Universal Render Pipeline > Lit`
  - 勾选 `Emission` 复选框

---

## 🧪 快速测试

### 测试宏是否生效

在 **任意脚本** 中添加：
```csharp
void Start()
{
#if HAS_URP_MATERIAL_PROPERTY
    Debug.Log("✅ HAS_URP_MATERIAL_PROPERTY 已定义");
#else
    Debug.LogError("❌ HAS_URP_MATERIAL_PROPERTY 未定义！请在 Project Settings > Player > Scripting Define Symbols 中添加");
#endif
}
```

**运行 Play**：
- 看到 `✅` → 宏正常
- 看到 `❌` → 必须添加宏

---

### 测试 Emission 组件

**临时调试代码**（添加到 `CubeSelectionManager.SelectCube` 方法末尾）：

```csharp
// 检查 Entity 是否有 Emission 组件
#if HAS_URP_MATERIAL_PROPERTY
if (_entityManager.HasComponent<Unity.Rendering.URPMaterialPropertyEmissionColor>(entity))
{
    Debug.Log("✅ Entity 有 Emission 组件");
    var emission = _entityManager.GetComponentData<Unity.Rendering.URPMaterialPropertyEmissionColor>(entity);
    Debug.Log($"Emission 值: {emission.Value}");
}
else
{
    Debug.LogError("❌ Entity 缺少 Emission 组件！");
}
#else
Debug.LogError("❌ HAS_URP_MATERIAL_PROPERTY 未定义！");
#endif
```

**点击方块后 Console 应显示**：
```
✅ Entity 有 Emission 组件
Emission 值: (0, 0, 0, 0)
```

---

## 🛠️ 完整解决流程

### 步骤1：添加宏定义
1. Project Settings > Player > Scripting Define Symbols
2. 添加 `HAS_URP_MATERIAL_PROPERTY`
3. **等待编译完成**（右下角转圈消失）

### 步骤2：配置 Cube 材质
1. 选中 Cube Prefab
2. Material Shader → `URP/Lit`
3. 勾选 `Emission` 复选框

### 步骤3：重新进入 Play
1. **完全退出 Play 模式**
2. 重新进入 Play（确保重新生成 Entity）
3. 点击方块

### 步骤4：验证效果
- ✅ 方块开始脉冲发光（黄色）
- ✅ 强度在 0.6 ~ 1.0 之间波动

---

## 📊 系统架构

```
用户点击
    ↓
CubeSelectionManager.SelectCube()
    ↓
设置 SelectionState.IsSelected = 1
设置 HighlightState.Intensity = 1.2
    ↓
HighlightRenderSystem.OnUpdate()
    ↓
计算脉冲动画（sin 波）
    ↓
写入 URPMaterialPropertyEmissionColor.Value
    ↓
URP 渲染 Emission（发光）
```

**关键点**：
- `SelectionState` → 标记选中状态
- `HighlightState` → 存储强度、颜色、动画时间
- `URPMaterialPropertyEmissionColor` → URP 读取的材质属性
- `HighlightRenderSystem` → 计算动画并写入材质

---

## 🐛 常见问题

### ❌ 编译错误：URPMaterialPropertyEmissionColor 不存在

**原因**：没有安装 `com.unity.entities.graphics` 包

**解决**：
1. `Window > Package Manager`
2. 搜索 `Entities Graphics`
3. 点击 `Install`

---

### ❌ 点击后没有任何反应

**检查**：
1. Console 有选中日志吗？
   - 有 → 问题在渲染
   - 没有 → 问题在选择逻辑（回到上一步）

2. 定义了宏吗？
   - 添加测试代码检查

3. Entity 有 Emission 组件吗？
   - 添加调试代码检查

---

### ❌ 方块闪烁一下就消失

**原因**：`EmissionIntensity` 太低或颜色太暗

**解决**：
- `CubeSelectionManager.highlightIntensity` 改为 `2.0f`
- `highlightColor` 改为 `Color.yellow`（更亮）

---

### ❌ 所有方块都在发光

**原因**：`CubeLayoutSpawnerAuthoring.EmissionIntensity > 0`

**解决**：
- 选中 Spawner Authoring
- `Emission Intensity = 0`（关闭基础发光）
- 只有选中的方块才会发光

---

## ✅ 成功标志

1. **Console 日志**：
   ```
   [Selection] 选中 Cube：Entity=(X:Y), Type=0
   ✅ HAS_URP_MATERIAL_PROPERTY 已定义
   ✅ Entity 有 Emission 组件
   ```

2. **视觉效果**：
   - 方块开始脉冲发光
   - 黄色 Emission
   - 强度平滑变化
   - 右键取消后淡出

3. **Entity Inspector**（Window > Entities > Hierarchy）：
   - `SelectionState.IsSelected = 1`
   - `HighlightState.Intensity > 0`
   - `URPMaterialPropertyEmissionColor` 组件存在

---

## 📝 调试检查清单

运行 Play 后，依次检查：

- [ ] Console 有 `[Selection] 选中 Cube：...` 日志
- [ ] Console 有 `✅ HAS_URP_MATERIAL_PROPERTY 已定义`
- [ ] Console 有 `✅ Entity 有 Emission 组件`
- [ ] Cube 材质 Shader 是 `URP/Lit`
- [ ] 材质勾选了 `Emission`
- [ ] `HighlightRenderSystem` 在 Systems 窗口中运行
- [ ] Entity Inspector 显示 `URPMaterialPropertyEmissionColor` 组件

**全部勾选 → 必然发光！**

---

## 🎯 下一步

系统正常后：

1. **调整高亮参数**：
   - `highlightIntensity`（强度）
   - `highlightColor`（颜色）
   - 脉冲速度（`HighlightRenderSystem` 中的 `dt * 2f`）

2. **添加音效**：
   - 选中时播放 `click` 音效
   - 取消时播放 `deselect` 音效

3. **实现能力系统**：
   - 拉伸（Extend）
   - 吸附（Attach）
   - 形状转换（Shape Shift）

---

**最关键**：确保定义了 `HAS_URP_MATERIAL_PROPERTY` 宏！没有这个宏，所有高亮代码都不会执行。

祝调试成功！🔥



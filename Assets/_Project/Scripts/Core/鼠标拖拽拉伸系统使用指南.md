# 鼠标拖拽拉伸系统使用指南

## 📋 概述

新的鼠标拖拽拉伸系统专为跑酷游戏设计，提供更直观、更快速的cube操控体验。

### 🎯 核心优势

- ✅ **单手操作**：鼠标完成所有操作，不占用WASD移动键
- ✅ **所见即所得**：拖拽距离直接对应拉伸长度
- ✅ **快速响应**：适合跑酷游戏的快节奏需求
- ✅ **直观反馈**：实时预览 + 视觉引导

---

## 🎮 操作方式

### 拉伸Cube

1. **选择**：鼠标左键点击cube → 进入拉伸模式
2. **拖拽**：按住左键拖拽
   - 拖拽方向 → 拉伸方向（自动对齐到6个主轴）
   - 拖拽距离 → 拉伸长度
   - 绿色预览 → 可拉伸区域
   - 红色预览 → 碰撞区域
3. **确认**：松开鼠标左键 → 执行拉伸

### 收缩Cube

- **方法1**：鼠标右键点击已拉伸的cube → 收缩整条链
- **方法2**：ESC取消选择 → 退出拉伸模式

### 取消操作

- **ESC键**：取消选择，退出拉伸模式
- **右键点击空白**：取消选择

---

## ⚙️ 系统配置

### MouseDragExtendManager 设置

在Unity Inspector中可以调整以下参数：

#### 拖拽设置
- **Drag Threshold** (默认20像素)
  - 开始拖拽的最小距离
  - 防止误触
  - 建议：10-30像素

- **Pixels Per Cube** (默认30像素)
  - 每拖拽多少像素增加1个cube长度
  - 控制拉伸敏感度
  - 建议：20-50像素

- **Max Extend Length** (默认10)
  - 最大拉伸长度
  - 根据关卡设计调整

- **Min Extend Length** (默认1)
  - 最小拉伸长度
  - 通常保持为1

#### 方向对齐
- **Snap To Main Axis** (默认true)
  - 自动对齐到6个主轴方向（前后左右上下）
  - 建议保持开启，更易控制

- **Direction Angle Threshold** (默认30度)
  - 方向判定的角度阈值
  - 暂时未使用，预留

#### 收缩设置
- **Enable Retract** (默认true)
  - 启用右键收缩功能

- **Retract Whole Chain** (默认true)
  - true = 收缩整条链
  - false = 逐个收缩（待完善）

#### 视觉反馈
- **Show Drag Line** (默认true)
  - 显示拖拽轨迹线
  - 辅助玩家判断方向和距离

- **Drag Line Color** (默认青色)
  - 拖拽线颜色

#### 调试
- **Show Debug Log** (默认true)
  - 输出调试日志到Console
  - 开发时建议开启

- **Show Debug GUI** (默认true)
  - 显示屏幕调试信息
  - 开发时建议开启

---

## 🔧 集成步骤

### 1. 添加MouseDragExtendManager

在场景中找到或创建一个管理器GameObject，添加组件：

```
GameObject: ExtendManagers
├─ CubeSelectionManager（保留）
├─ MouseDragExtendManager（新增）✨
└─ InputModeCoordinator（可选）
```

### 2. 设置引用

在 `MouseDragExtendManager` Inspector中：
- **Main Camera**：自动获取，或手动指定主相机

### 3. 兼容性处理

**与旧系统共存**：
- `ExtendInputManager`（键盘拉伸）可以暂时保留
- 两个系统可以同时存在，但建议最终只保留一个

**与移动系统协调**：
- 鼠标操作不占用WASD，可以边移动边操作
- 如果需要禁止同时操作，使用 `InputModeCoordinator`

### 4. 测试检查清单

- [ ] 能正常选中cube（左键点击）
- [ ] 拖拽时显示预览（绿色/红色线框）
- [ ] 拖拽方向正确对齐到6轴
- [ ] 拖拽距离对应拉伸长度
- [ ] 松开鼠标确认拉伸
- [ ] 右键收缩已拉伸cube
- [ ] ESC取消选择
- [ ] 调试信息正常显示

---

## 🎨 视觉反馈说明

### 预览效果（ExtendPreviewSystem）

- **绿色线框**：可以拉伸的cube位置（无碰撞）
- **红色线框**：碰撞区域，无法拉伸
- **黄色箭头**：拉伸方向指示
- **青色拖拽线**：鼠标拖拽轨迹（屏幕空间）

### 屏幕调试信息

左上角显示：
- 当前选中状态
- 拖拽状态
- 拉伸方向和长度
- 拖拽距离

可通过 `showDebugGUI = false` 关闭。

---

## 🚀 性能优化建议

### 1. 预览频率控制

当前预览系统每帧更新，对于大量cube可能有性能影响。

**优化方案**：
- 限制最大预览长度（10个cube以内）
- 使用对象池复用预览对象
- 降低预览更新频率（30fps足够）

### 2. 碰撞检测优化

当前使用 `NativeParallelHashMap` 进行O(1)碰撞检测，已经很高效。

**进一步优化**：
- 预览时使用Burst编译的Job
- 批量检测多个方向

### 3. 输入处理优化

当前在 `Update()` 中每帧查询选中entity。

**优化方案**：
- 使用事件驱动，选中/取消选中时触发
- 缓存选中entity，减少查询

---

## 🐛 常见问题

### Q1: 拖拽没有反应
**检查**：
- `MouseDragExtendManager` 是否启用
- `Main Camera` 引用是否正确
- Cube是否有 `InteractableCubeTag` 和 `ExtendableTag`

### Q2: 方向不正确
**检查**：
- `Snap To Main Axis` 是否开启
- 相机角度是否合适（建议45度俯视角）
- 拖拽距离是否超过 `dragThreshold`

### Q3: 无法收缩
**检查**：
- `Enable Retract` 是否开启
- 右键点击的是否是拉伸出的cube（有 `ExtendChainData`）
- `RetractSystem` 是否正常运行

### Q4: 预览显示不准确
**检查**：
- `ExtendPreviewSystem` 是否正常运行
- `OccupiedCubeMap` 是否初始化
- Console是否有碰撞检测错误

### Q5: 与角色移动冲突
**解决方案**：
- 使用 `InputModeCoordinator` 协调输入
- 或者在拖拽时临时禁用角色移动

---

## 🔄 从旧系统迁移

如果你之前使用 `ExtendInputManager`（键盘拉伸），迁移步骤：

1. **添加新组件**
   ```
   添加 MouseDragExtendManager
   保留 ExtendInputManager（先不删除）
   ```

2. **测试新系统**
   ```
   测试鼠标拖拽是否正常
   测试右键收缩是否正常
   ```

3. **禁用旧系统**
   ```
   取消勾选 ExtendInputManager
   或设置 autoDisableMovement = false
   ```

4. **完全移除旧系统**（可选）
   ```
   确认新系统完全正常后
   删除 ExtendInputManager 组件
   ```

---

## 📊 与旧系统对比

| 特性 | 键盘拉伸<br>(ExtendInputManager) | 鼠标拖拽<br>(MouseDragExtendManager) |
|------|----------------------------------|--------------------------------------|
| **操作方式** | 按住WASD选方向+持续按住增加长度 | 鼠标拖拽，方向+长度一次完成 |
| **速度** | 较慢（需等待holdTime） | 快速（拖拽即时响应） |
| **精确度** | 低（按住时间控制） | 高（拖拽距离精确控制） |
| **直观性** | 中（需要记忆键位） | 高（所见即所得） |
| **适合游戏类型** | 解谜游戏 | 跑酷游戏 ✨ |
| **键盘占用** | WASD被占用 | 不占用 ✅ |
| **收缩功能** | 未实现 | 右键收缩 ✅ |

---

## 🎯 未来改进方向

### 1. 手感优化
- [ ] 添加拖拽震动反馈（手柄）
- [ ] 优化拖拽曲线（缓入缓出）
- [ ] 添加音效反馈

### 2. 功能扩展
- [ ] 逐个收缩模式（按住右键逐渐收缩）
- [ ] 曲线拉伸（非直线）
- [ ] 预设形状快速生成

### 3. UI优化
- [ ] 添加拖拽进度条
- [ ] 优化预览材质（半透明cube）
- [ ] 添加操作教程提示

### 4. 多人/网络
- [ ] 网络同步支持
- [ ] 多人协作拉伸

---

## 📝 示例关卡设计

基于新的鼠标拖拽系统，推荐的关卡设计：

### 教学关卡
```
目标：教会玩家鼠标拖拽操作
1. 简单的鸿沟，需要拉伸一个平台
2. 提示：点击cube，拖拽向前
3. 成功后，引导收缩（右键）
```

### 速度挑战关卡
```
目标：快速拉伸多个cube完成跑酷
1. 多个连续的间隙
2. 需要快速点击-拖拽-松开
3. 计时挑战
```

### 精确操作关卡
```
目标：精确控制拉伸长度和方向
1. 狭窄空间，需要精确拉伸
2. 拉伸过长会碰撞
3. 需要尝试不同方向
```

---

## 📚 相关文档

- **拉伸系统技术架构.md** - 底层ECS架构说明
- **拉伸系统快速开始.md** - 快速上手指南
- **输入系统模式切换指南.md** - 输入模式协调

---

*本文档将持续更新，欢迎反馈和建议！*

**版本**：v1.0  
**最后更新**：2025-10-26  
**作者**：AI Assistant


